name: Build WinuX (Windows)

on:
  push:
    branches: [ master ]
    paths:
      - "src/**"
      - ".github/workflows/windows-build.yml"
  pull_request:
    branches: [ master ]
    paths:
      - "src/**"
      - ".github/workflows/windows-build.yml"
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Python (for aqtinstall) ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- Cache Qt installation ---
      - name: Cache Qt 5.15.2 (MSVC 2019 x64)
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: C:\Qt
          key: qt-5.15.2-msvc2019_64

      - name: Install Qt 5.15.2 (MSVC 2019 x64)
        if: steps.cache-qt.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install aqtinstall
          aqt install-qt windows desktop 5.15.2 win64_msvc2019_64 --outputdir C:\Qt

      - name: Add Qt to PATH
        shell: pwsh
        run: |
          echo "C:\Qt\5.15.2\msvc2019_64\bin" >> $env:GITHUB_PATH
          echo "QtDir=C:\Qt\5.15.2\msvc2019_64" >> $env:GITHUB_ENV

      # --- MSVC environment (no manual VS install) ---
      - name: Set up MSVC developer command prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # --- Detect MSC version and feed qmake ---
      - name: Detect MSVC version for qmake
        id: mscver
        shell: pwsh
        run: |
          $clLine = & cl 2>&1 | Select-String 'Compiler Version'
          if (-not $clLine) {
            Write-Error "Failed to run cl.exe to detect MSVC version."
          }

          # Example line:
          #   Microsoft (R) C/C++ Optimizing Compiler Version 19.39.33521 for x64
          if ($clLine -match 'Version\s+19\.(\d{2})\.\d+') {
            $mscVer = "19$($Matches[1])"
          } else {
            # Fallback: typical value for VS 2022
            $mscVer = "1930"
          }

          Write-Host "Detected QMAKE_MSC_VER = $mscVer"
          echo "QMAKE_MSC_VER=$mscVer" >> $env:GITHUB_ENV

      # --- qmake configure (release) ---
      - name: Configure with qmake (release)
  shell: pwsh
  working-directory: src/unetbootin
  run: |
    if (-not $env:QMAKE_MSC_VER) {
      Write-Error "QMAKE_MSC_VER is not set in the environment."
    }
    qmake "QMAKE_MSC_VER=$env:QMAKE_MSC_VER" CONFIG+=release unetbootin.pro

      # --- Build with nmake ---
      - name: Build with nmake
        shell: pwsh
        working-directory: src/unetbootin
        run: |
          nmake /NOLOGO

      # --- Upload Windows EXE artifact ---
      - name: Upload WinuX .exe artifact
        uses: actions/upload-artifact@v4
        with:
          name: WinuX-windows-exe
          path: src/unetbootin/release/*.exe
