name: build-windows

on:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/windows-build.yml"
      - "src/**"
      - "doc/**"
      - "po/**"
  pull_request:
    branches: [ master ]
    paths:
      - ".github/workflows/windows-build.yml"
      - "src/**"
      - "doc/**"
      - "po/**"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      # We rely on the preinstalled Visual Studio on windows-latest.
      # If MSVC is ever missing, we can re-enable a choco install here.

      - name: Set up MSVC developer command prompt
        shell: pwsh
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) {
            throw "vswhere.exe not found at $vswhere"
          }

          $installationPath = & $vswhere -latest `
            -products * `
            -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 `
            -property installationPath

          if (-not $installationPath) {
            throw "MSVC Build Tools installation not found."
          }

          $vcvarsPath = Join-Path $installationPath "VC\Auxiliary\Build\vcvars64.bat"
          if (-not (Test-Path $vcvarsPath)) {
            throw "vcvars64.bat not found at $vcvarsPath"
          }

          "VCVARS_PATH=$vcvarsPath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install aqtinstall
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install aqtinstall

      - name: Install Qt 5.15.2 (MSVC 2019)
        shell: pwsh
        run: |
          python -m aqt install-qt --outputdir C:\Qt windows desktop 5.15.2 win64_msvc2019_64 `
            --archives qtbase qttools
          "QtDir=C:\Qt\5.15.2\msvc2019_64"        | Out-File -FilePath $env:GITHUB_ENV -Append
          "C:\Qt\5.15.2\msvc2019_64\bin"         | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Detect MSVC version for qmake
        shell: pwsh
        run: |
          $vcvars = $env:VCVARS_PATH
          if (-not $vcvars) {
            throw "VCVARS_PATH not set in environment."
          }

          $cmd = "`"$vcvars`" && cl 2>&1"
          $output = cmd.exe /c $cmd

          $match = $output | Select-String -Pattern 'Microsoft.*?Version\s+(\d+)\.(\d+)'
          if (-not $match) {
            Write-Host "cl.exe output:"
            Write-Host $output
            throw "Failed to parse cl.exe version from output."
          }

          $major = [int]$match.Matches[0].Groups[1].Value
          $minor = [int]$match.Matches[0].Groups[2].Value

          $mscVer = $major * 100 + $minor

          Write-Host "Detected cl.exe version $major.$minor -> QMAKE_MSC_VER=$mscVer"
          "QMAKE_MSC_VER=$mscVer" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Configure with qmake (release)
        shell: cmd
        working-directory: src/unetbootin
        env:
          QMAKE_MSC_VER: ${{ env.QMAKE_MSC_VER }}
        run: |
          echo Using QMAKE_MSC_VER=%QMAKE_MSC_VER%
          call "%VCVARS_PATH%"
          qmake CONFIG+=release unetbootin.pro

      - name: Build with nmake
        shell: cmd
        working-directory: src/unetbootin
        run: |
          call "%VCVARS_PATH%"
          nmake /NOLOGO

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: WinuX-windows-exe
          path: src/unetbootin/release/*.exe
